define(["jquery","core/notification","core/fragment","core/modal_factory","core/modal_events","core/templates","report_elucidsitereport/variables","report_elucidsitereport/select2","report_elucidsitereport/jquery.dataTables","report_elucidsitereport/dataTables.bootstrap4"],function(r,o,a,n,d,i,l){var s=null,e="#scheduletab",c="button.dropdown-toggle",u=e+" input#esr-sendduration",t=e+" .dropdown:not(.duration-dropdown)",f=t+" button.dropdown-toggle",p=e+" .dropdown.daily-dropdown button.dropdown-toggle",m=e+" .dropdown.weekly-dropdown button.dropdown-toggle",g=e+" .dropdown.monthly-dropdown button.dropdown-toggle",h=e+" input#esr-sendtime",w='<div class="w-full text-center"><i class="fa fa-spinner fa-spin" aria-hidden="true"></i></div>',b='<div class="alert alert-danger"><b>ERROR:</b> Error while scheduling email<div>',v='<div class="alert alert-success"><b>Success:</b> Email scheduled successfully<div>',y='[data-plugin="tabs"] .nav-link, [data-plugin="tabs"] .tab-pane',k='[aria-controls="scheduletab"], #scheduletab';function _(e,a){return a.getRoot().find("#esr-shceduled-emails").DataTable({ajax:{url:l.requestUrl,type:l.requestType,data:{action:"get_scheduled_emails_ajax",sesskey:r(e).data("sesskey"),data:JSON.stringify({blockname:r(e).attr("data-blockname"),href:r(e).attr("href"),region:r(e).attr("data-region")})}},scrollY:"300px",scrollCollapse:!0,oLanguage:{sEmptyTable:"There is no scheduled emails"},columns:[{data:"esrtoggle"},{data:"esrname"},{data:"esrcomponent"},{data:"esrnextrun"},{data:"esrfrequency"},{data:"esrmanage"}],bInfo:!1,lengthChange:!1,paging:!1})}function x(e){var a="#wdm-elucidsitereport > div";e<780?r(a).addClass("col-lg-12"):r(a).removeClass("col-lg-12"),r(document).find(".table.dataTable").DataTable().draw()}r(document).ready(function(){x(r("#page-admin-report-elucidsitereport-index .page-content").width()),r(window).on("resize",function(){x(l.pluginPage.width())}),r(document).on("click",'.export-dropdown a[data-action="email"]',function(e){e.preventDefault();var t=this;n.create({type:n.types.SAVE_CANCEL,title:"Email Dialog Box",body:a.loadFragment("report_elucidsitereport","email_dialog",r(t).data("contextid"),{blockname:r(t).data("blockname")})},r(this)).done(function(e){var a=e.getRoot();a.on(d.hidden,function(){e.destroy()}),a.on(d.save,function(){!function(e,a){r.ajax({url:e.href,type:"POST",data:a.find("form").serialize()}).done(function(e){(e=r.parseJSON(e)).error?o.addNotification({message:e.errormsg,type:"error"}):o.addNotification({message:"Email has been sent",type:"info"})}).fail(function(){o.addNotification({message:"Failed to send the email",type:"error"})})}(t,a)}),e.setSaveButtonText("Send"),e.show()})}),r(document).on("click",'.export-dropdown a[data-action="emailscheduled"]',function(e){e.preventDefault();var t=this;n.create({title:"Schedule Emails",body:i.render("report_elucidsitereport/email_schedule_tabs",{})},r(this)).done(function(e){var a=e.getRoot();e.modal.addClass("modal-lg"),a.on(d.bodyRendered,function(){a.find("#esr-blockname").val(r(t).data("blockname")),a.find("#esr-region").val(r(t).data("region")),s=_(t,e)}),a.on(d.hidden,function(){e.destroy()}),function(e,a,t){a.on("click","#scheduletab .dropdown a.dropdown-item",function(){!function(e){var a=r(e).data("value"),t=r(e).text(),o=r(e).closest(".dropdown").find(c);o.text(t),o.data("value",a)}(this)}),a.on("click","#scheduletab .dropdown.duration-dropdown a.dropdown-item",function(){!function(e,a){var t=r(e).data("value");r(e).text();a.find(u).val(t),r(f).hide();var o=null;switch(t){case 1:o=r(m);break;case 2:o=r(g);break;default:o=r(p)}o.show();var n=o.data("value");r(h).val(n)}(this,a)}),a.on("click","#scheduletab .dropdown:not(.duration-dropdown) a.dropdown-item",function(){a.find(h).val(r(this).data("value"))}),a.on("click","#listemailstab .esr-email-sched-setting",function(){!function(e,d){r(e).data("id"),r(e).data("blockname"),r(e).data("region");r.ajax({url:l.requestUrl,type:l.requestType,sesskey:r(e).data("sesskey"),data:{action:"get_scheduled_email_detail_ajax",sesskey:r(e).data("sesskey"),data:JSON.stringify({id:r(e).data("id"),blockname:r(e).data("blockname"),region:r(e).data("region")})}}).done(function(e){if(e.error)console.log(e);else{var o=null,n=null;r.each(e.data,function(e,a){if("object"==typeof a)d.find("#esr-blockname").val(a.blockname),d.find("#esr-region").val(a.region);else if("esrduration"===e){var t='[aria-labelledby="durationcount"] .dropdown-item[data-value="'+a+'"]';o=a,d.find(t).click()}else"esrtime"===e?n=a:r('[name="'+e+'"]').val(a)});var a='.dropdown-item[data-value="'+n+'"]',t=null;switch(o){case"1":console.log("test"),t=r(".weekly-dropdown");break;case"2":t=r(".monthly-dropdown");break;default:t=r(".daily-dropdown")}t.find(a).click(),d.find(y).removeClass("active show"),d.find(k).addClass("active show")}console.log(e)}).fail(function(e){console.log(e)})}(this,a)}),function(t,o,n){o.on("click",'[data-action="save"]',function(){var a=o.find(".esr-form-error");a.html(w).show();var e=l.getUrlParams(t.href,"filter");r.ajax({url:M.cfg.wwwroot+"/report/elucidsitereport/download.php?format=emailscheduled&filter="+e,type:"POST",data:o.find("form").serialize()}).done(function(e){(e=r.parseJSON(e)).error?(a.html(b),console.log(e.error)):(s&&s.destroy(),s=_(t,n),a.html(v))}).fail(function(e){a.html(b),console.log(e)}).always(function(){a.delay(3e3).fadeOut("slow")})})}(e,a,t)}(t,a,e),e.show()})})})});