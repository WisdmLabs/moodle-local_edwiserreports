"use strict";define(["jquery","core/ajax","core/modal_factory","core/modal_events","core/templates","core/notification","core/str","local_edwiserreports/jquery.dataTables","local_edwiserreports/dataTables.bootstrap4"],function(e,t,o,s,r,a,l){var n=".field .custom-field-checkbox",d=".reports-filter-body .custom-field-select",i="#wdm-cohort-select",c="#wdm-course-select",p="#wdm-custom-reports-save",m="#wdm-customreports-save-form",u='[id^="wdm-desktopenable-"]',f='#cr-list-table a[data-action="delete"]',h=null,_=null,g=M.util.get_string("savecustomreport","local_edwiserreports"),w=[],y=[],v=[],b=0,C={downloadenable:!0},x={selector:".reports-preview-body .reports-preview-content.loader",show:function(){e(this.selector).removeClass("d-none").addClass("d-flex")},hide:function(){e(this.selector).removeClass("d-flex").addClass("d-none")}},k={selector:".reports-preview-body .reports-preview-content",show:function(){e(this.selector+":not(.loader)").removeClass("d-none").addClass("d-flex"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),x.hide()},hide:function(){e(this.selector+":not(.loader)").removeClass("d-flex").addClass("d-none"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),x.show()},empty:function(){e(this.selector+".empty").removeClass("d-none").addClass("d-flex"),e(this.selector+":not(.empty)").removeClass("d-flex").addClass("d-none"),x.hide()}},N={selector:".reports-list-body .reports-list-content.loader",show:function(){e(this.selector).removeClass("d-none").addClass("d-flex")},hide:function(){e(this.selector).removeClass("d-flex").addClass("d-none")}},T={selector:".reports-list-body .reports-list-content",show:function(){e(this.selector+":not(.loader)").removeClass("d-none").addClass("d-flex"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),N.hide()},hide:function(){e(this.selector+":not(.loader)").removeClass("d-flex").addClass("d-none"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),N.show()},empty:function(){e(this.selector+".empty").removeClass("d-none").addClass("d-flex"),e(this.selector+":not(.empty)").removeClass("d-flex").addClass("d-none"),N.hide()}};function S(){w=[],v=[e(i).val()],y=[e(c).val()],e(n+":checked").each(function(){w.push(e(this).val())});var o=t.call([{methodname:"local_edwiserreports_get_customreports_data",args:{params:JSON.stringify({fields:w,cohorts:v,courses:y})}}]);0==w.length?(k.empty(),e(p).prop("disabled",!0)):(k.hide(),o[0].done(function(t){if(t.success){h&&(h.clear().destroy(),e("#cr-preview-table").html(""));var o=JSON.parse(t.data);h=e("#cr-preview-table").DataTable({columns:o.columns,data:o.reportsdata,bInfo:!1,bFilter:!1,searching:!1,lengthChange:!1,drawCallback:function(){e(".dataTables_paginate > .pagination").addClass("pagination-sm pull-right"),e(".dataTables_filter").addClass("pagination-sm pull-right")}})}}).always(function(){k.show(),e(p).prop("disabled",!1)}))}function J(){o.create({title:g,type:o.types.SAVE_CANCEL,body:r.render("local_edwiserreports/custom_reports_save_form",C)}).done(function(t){var o=t.getRoot();o.find(".modal-dialog").addClass("modal-lg"),t.show(),o.on(s.save,function(s){s.preventDefault(),o.find("input").on("input",function(){e('[id^="id_error_crb"]').html("")});var r=e(m).serializeArray().reduce(function(e,t){return e[t.name]=t.value,e},{});(function(t){var o=!0;return""==t.reportname&&(e("#id_error_crb_reportname").html(M.util.get_string("emptyfullname","local_edwiserreports")).show(),o=!1),""==t.reportshortname&&(e("#id_error_crb_reportshortname").html(M.util.get_string("emptyshortname","local_edwiserreports")).show(),o=!1),/[ `!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/.test(t.reportshortname)&&(e("#id_error_crb_reportshortname").html(M.util.get_string("nospecialchar","local_edwiserreports")).show(),o=!1),o})(r)&&(r.querydata={selectedfield:w,cohorts:v,courses:y},O(r,t))})})}function O(o,s){t.call([{methodname:"local_edwiserreports_save_customreports_data",args:{params:JSON.stringify(o)}}])[0].done(function(t){t.success?(s&&(C=JSON.parse(t.reportsdata)),e("#user-notifications .close").click(),a.addNotification({message:M.util.get_string("reportssavesuccess","local_edwiserreports"),type:"success"})):(e("#user-notifications .close").click(),a.addNotification({message:t.errormsg,type:"error"})),s&&(e("html, body").animate({scrollTop:0},"slow"),q(),s.destroy())})}function q(){t.call([{methodname:"local_edwiserreports_get_customreports_list",args:{params:JSON.stringify({})}}])[0].done(function(t){var o=JSON.parse(t.data);t.success&&(0==o.length?T.empty():(_&&(_.clear().destroy(),e("#cr-list-table").html("")),(_=e("#cr-list-table").DataTable({columns:[{data:"sno",title:M.util.get_string("sno","local_edwiserreports")},{data:"fullname",title:M.util.get_string("reportname","local_edwiserreports")},{data:"shortname",title:M.util.get_string("reportshortname","local_edwiserreports")},{data:"createdby",title:M.util.get_string("createdby","local_edwiserreports")},{data:"datecreated",title:M.util.get_string("datecreated","local_edwiserreports")},{data:"managehtml",title:M.util.get_string("manage","local_edwiserreports")}],order:[[2,"asc"]],data:o,bInfo:!1,bFilter:!1,searching:!1,lengthChange:!1,drawCallback:function(){e(".dataTables_paginate > .pagination").addClass("pagination-sm pull-right"),e(".dataTables_filter").addClass("pagination-sm pull-right")}})).on("order.dt search.dt",function(){_.column(0,{search:"applied",order:"applied"}).nodes().each(function(e,t){e.innerHTML=t+1})}).draw(),T.show()))})}function D(){e(n).on("change",function(){S()}),e(d).on("change",function(){S()}),e(p).on("click",function(){J()}),q(),e(document).on("change",u,function(){O({reportsid:e(this).data("reportsid"),enabledesktop:e(this).is(":checked")?1:0,action:"enabledesktop"},null)}),e(document).on("click",f,function(o){o.preventDefault();var s=e(this).data("reportsid");l.get_strings([{key:"deletecustomreportstitle",component:"local_edwiserreports"},{key:"deletecustomreportsquestion",component:"local_edwiserreports"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(r){a.confirm(r[0],r[1],r[2],r[3],e.proxy(function(){var o;o=s,t.call([{methodname:"local_edwiserreports_delete_custom_report",args:{params:JSON.stringify({reportsid:o})}}])[0].done(function(e){e.success?a.addNotification({message:e.message,type:"success"}):a.addNotification({message:e.message,type:"error"})}).always(function(){e("html, body").animate({scrollTop:0},"slow"),q()})},o.currentTarget))})})}return{init:function(){e(document).ready(function(){D(),(b=e("#wdm_custom_reports_id").val())&&(C.reportsid=b,C.reportname=e("#wdm_custom_reports_fullname").val(),C.reportshortname=e("#wdm_custom_reports_shortname").val(),C.downloadenable=e("#wdm_custom_reports_downloadenable").val(),C.enabledesktop=e("#wdm_custom_reports_desktopenable").val(),S())})}}});
//# sourceMappingURL=customreportsblock.min.js.map
