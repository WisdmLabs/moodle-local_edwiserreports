define(["jquery","core/notification","core/fragment","core/modal_factory","core/modal_events","core/templates","core/str","local_sitereport/variables","local_sitereport/selectors","local_sitereport/templateselector","local_sitereport/jspdf","local_sitereport/select2","local_sitereport/jquery.dataTables","local_sitereport/dataTables.bootstrap4"],(function(e,t,a,o,n,i,r,l,d,s,c){var u=null,f="#scheduletab",m=f+" input#esr-sendtime",p='<div class="w-full text-center"><i class="fa fa-spinner fa-spin" aria-hidden="true"></i></div>',g=M.util.get_string("scheduleerrormsg","local_sitereport"),h=M.util.get_string("schedulesuccessmsg","local_sitereport"),b=M.util.get_string("deletesuccessmsg","local_sitereport"),v=M.util.get_string("deleteerrormsg","local_sitereport"),y=M.util.get_string("emptyerrormsg","local_sitereport"),k=M.util.get_string("emailinvaliderrormsg","local_sitereport");function w(t){t.modal.find(".comparisontable .switch-capability").on("click",(function(t){var a=e(t.currentTarget).find("input[type=radio]"),o=a.filter(":checked"),n=a.eq(a.index(o)+1);0===n.length&&(n=a.eq(0)),n.prop("checked",!0);var i=n.data("strpermission"),r=n.data("permissionclass");e(t.currentTarget).removeClass("inherit allow prevent prohibit"),e(t.currentTarget).addClass(r),e(t.currentTarget).find("label").html(i)}))}function _(t,a){var o=a.getRoot().find("#esr-shceduled-emails");return e(document).on("click",'[aria-controls="listemailstab"]',(function(){e(window).resize()})),o.DataTable({ajax:{url:l.requestUrl+"?sesskey="+t.sesskey,type:l.requestType,data:{action:"get_scheduled_emails_ajax",data:JSON.stringify({blockname:t.blockname,region:t.region})}},language:{searchPlaceholder:"Search shceduled email",emptyTable:"There is no scheduled emails"},drawCallback:function(){e(".dataTables_paginate > .pagination").addClass("pagination-sm pull-right"),e(".dataTables_filter").addClass("pagination-sm pull-right")},order:[[2,"asc"]],columns:[{data:"esrtoggle",orderable:!1},{data:"esrname",orderable:!0},{data:"esrcomponent",orderable:!0},{data:"esrnextrun",orderable:!0},{data:"esrfrequency",orderable:!0},{data:"esrmanage",orderable:!1}],responsive:!0,bInfo:!1,lengthChange:!1})}function x(t){var a="#wdm-elucidsitereport > div";t<780?e(a).addClass("col-lg-12"):e(a).removeClass("col-lg-12"),e(a).find(".table.dataTable").DataTable().draw()}e(document).ready((function(){x(e("#page-admin-report-elucidsitereport-index .page-content").width()),e(window).on("resize",(function(){x(l.pluginPage.width())})),e(document).on("click",'.download-links button[value="pdf"]',(function(t){t.preventDefault();var a=e(this).closest("form");e.ajax({url:a.attr("action"),type:"POST",data:{type:e(this).val(),block:a.find('input[name="block"]').val(),filter:a.find('input[name="filter"]').val(),cohortid:a.find('input[name="cohortid"]').val(),region:a.find('input[name="region"]').val()}}).done((function(e){e=JSON.parse(e);var t=c("p","pt","a4"),a={top:40,bottom:30,left:10,width:"100%"};t.setFontSize(10);t.fromHTML(e.data.html,a.left,a.top,{width:a.width,elementHandlers:{"#bypassme":function(e,t){return!0}}},(function(a){t.save(e.data.filename)}),a)})).always((function(){e(document).find("#cover-spin").hide()}))})),e(document).on("click",'.download-links button[value="email"]',(function(a){a.preventDefault();var d=l.getScheduledEmailFormContext(),s=e(this).closest("form").serializeArray();e(s).each((function(e,t){d[t.name]=t.value})),o.create({title:l.getEmailModalHeader(d.blockname,1),body:i.render("local_sitereport/email_schedule_tabs",d)},e(this)).done((function(a){var o=a.getRoot();a.modal.addClass("modal-lg"),o.on(n.bodyRendered,(function(){o.find("#esr-blockname").val(d.blockname),o.find("#esr-region").val(d.region),o.find("#esr-sesskey").val(d.sesskey),u=_(d,a)})),o.on(n.hidden,(function(){a.destroy()})),function(a,o,n){o.on("click","#scheduletab .dropdown a.dropdown-item",(function(){var t,a,o,n;a=e(t=this).data("value"),o=e(t).text(),(n=e(t).closest(".dropdown").find("button.dropdown-toggle")).text(o),n.data("value",a)})),o.on("click","#scheduletab .dropdown.duration-dropdown a.dropdown-item",(function(){!function(t,a){var o=e(t).data("value");e(t).text();a.find("#scheduletab input#esr-sendduration").val(o),e("#scheduletab .dropdown:not(.duration-dropdown) button.dropdown-toggle").hide();var n=null;switch(o){case 1:n=e("#scheduletab .dropdown.weekly-dropdown button.dropdown-toggle");break;case 2:n=e("#scheduletab .dropdown.monthly-dropdown button.dropdown-toggle");break;default:n=e("#scheduletab .dropdown.daily-dropdown button.dropdown-toggle")}n.show();var i=n.data("value");e(m).val(i)}(this,o)})),o.on("click","#scheduletab .dropdown:not(.duration-dropdown) a.dropdown-item",(function(){o.find(m).val(e(this).data("value"))})),o.on("click","#listemailstab .esr-email-sched-setting",(function(){!function(t,a){var o=e(t).data("id"),n=e(t).data("blockname"),i=e(t).data("region");e.ajax({url:l.requestUrl,type:l.requestType,sesskey:e(t).data("sesskey"),data:{action:"get_scheduled_email_detail_ajax",sesskey:e(t).data("sesskey"),data:JSON.stringify({id:o,blockname:n,region:i})}}).done((function(t){(t=JSON.parse(t)).error?console.log(t):(!function(t,a,o){var n=null,i=null;e.each(t.data,(function(t,a){if("object"==typeof a)o.find("#esr-blockname").val(a.blockname),o.find("#esr-region").val(a.region);else if("esrduration"===t){var r='[aria-labelledby="durationcount"] .dropdown-item[data-value="'+a+'"]';n=a,o.find(r).click()}else if("esrtime"===t)i=a;else if("esremailenable"===t){var l=e('input[name="'+t+'"]');a?l.prop("checked",!0):l.prop("checked",!1)}else e('[name="'+t+'"]').val(a)}));var r='.dropdown-item[data-value="'+i+'"]',l=null;switch(n){case"1":l=e(".weekly-dropdown");break;case"2":l=e(".monthly-dropdown");break;default:l=e(".daily-dropdown")}l.find(r).click()}(t,0,a),a.find('[data-plugin="tabs"] .nav-link, [data-plugin="tabs"] .tab-pane').removeClass("active show"),a.find('[aria-controls="scheduletab"], #scheduletab').addClass("active show"))})).fail((function(e){console.log(e)}))}(this,o)})),o.on("click","#listemailstab .esr-email-sched-delete",(function(i){a.id=e(this).data("id"),r.get_strings([{key:"confirmemailremovaltitle",component:"local_sitereport"},{key:"confirmemailremovalquestion",component:"local_sitereport"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done((function(r){t.confirm(r[0],r[1],r[2],r[3],e.proxy((function(){!function(t,a,o){var n=t.id,i=t.block,r=t.region,d=a.find(".esr-form-error");d.html(p).show(),console.log(t),e.ajax({url:l.requestUrl,type:l.requestType,sesskey:t.sesskey,data:{action:"delete_scheduled_email_ajax",sesskey:t.sesskey,data:JSON.stringify({id:n,blockname:i,region:r})}}).done((function(e){e.error?d.html(v):(u&&u.destroy(),u=_(t,o),d.html(b))})).fail((function(e){d.html(v),console.log(e)})).always((function(){d.delay(3e3).fadeOut("slow")}))}(a,o,n)}),i.currentTarget))}))})),o.on("change","#listemailstab [id^='esr-toggle-']",(function(){a.id=e(this).data("id"),function(t,a,o){var n=t.id,i=t.block,r=t.region,d=t.sesskey,s=a.find(".esr-form-error");e.ajax({url:l.requestUrl,type:l.requestType,data:{action:"change_scheduled_email_status_ajax",sesskey:d,data:JSON.stringify({id:n,blockname:i,region:r})}}).done((function(e){e=JSON.parse(e),console.log(e),e.error?(s.html(e.errormsg),s.show(),s.delay(3e3).fadeOut("slow")):(s.html(e.successmsg),s.show(),s.delay(3e3).fadeOut("slow"))}))}(a,o)})),o.on("click",'[data-action="send"]',(function(){!function(t,a,o){var n=t.filter,i=t.filter,r=t.block,l=o.find(".esr-form-error");l.html(p).show(),e(document).find("#cover-spin")&&e("body").append('<div id="cover-spin"></div>');e(document).find("#cover-spin").show(0),e.ajax({url:M.cfg.wwwroot+"/local/sitereport/download.php?type=email&filter="+n+"&cohortid="+i+"&block="+r,type:"POST",data:o.find("form").serialize()}).done((function(t){(t=e.parseJSON(t)).error?l.html('<div class="alert alert-danger"><b>ERROR:</b>'+t.errormsg+"</div>"):l.html('<div class="alert alert-success"><b>Success:</b>'+t.errormsg+"</div>")})).fail((function(){l.html('<div class="alert alert-danger"><b>ERROR:</b>'+response.errormsg+"</div>")})).always((function(){l.delay(3e3).fadeOut("slow"),e(document).find("#cover-spin").hide()}))}(a,0,o)})),function(t,a,o){a.on("click",'[data-action="save"]',(function(){var n=a.find(".esr-form-error");if(n.html(p).show(),function(e,t){var a=e.find('[name="esrname"]').val(),o=e.find('[name="esrrecepient"]').val();if(""==a||""==o)return t.html(y).show(),!1;if(!/^(\s?[^\s,]+@[^\s,]+\.[^\s,]+\s?,)*(\s?[^\s,]+@[^\s,]+\.[^\s,]+)$/g.test(o))return t.html(k).show(),!1;return!0}(a.find("form"),n)){var i=t.filter,r=t.cohortid,l=t.block,d=M.cfg.wwwroot+"/local/sitereport/download.php?type=emailscheduled&filter="+i+"&cohortid="+r+"&block="+l;e.ajax({url:d,type:"POST",data:a.find("form").serialize()}).done((function(a){(a=e.parseJSON(a)).error?(n.html(g),console.log(a.error)):(u&&u.destroy(),u=_(t,o),n.html(h))})).fail((function(e){n.html(g),console.log(e)})).always((function(){n.delay(3e3).fadeOut("slow")}))}})),a.on("click",'[data-action="cancel"]',(function(){a.find('[name^=esr]:not(.d-none):not([id="esr-toggle-"])').val(""),a.find("#esr-id").val(-1)}))}(a,o,n)}(d,o,a),a.show()}))})),e("#wdm-elucidsitereport").removeClass("d-none"),e(document).on("click",d.blockSettingsBtn,(function(i){i.preventDefault();var r=e(i.currentTarget).data("contextid"),d=e(i.currentTarget).data("blockname"),s=e(i.currentTarget).data("action");if("edit"==s)o.create({title:"Edit Block Setting",body:a.loadFragment("local_sitereport","get_blocksetting_form",r,{blockname:d})}).done((function(a){var o=a.getRoot();a.modal.addClass("modal-dialog-centered"),o.on(n.bodyRendered,(function(){var o=a.modal.find(".block-settings-form");a.modal.find(".save-block-settings").on("click",(function(a){a.preventDefault();var n=o.serializeArray(),i={};e(n).each((function(e,t){i[t.name]=t.value})),function(a,o,n){o.blockname=a,o=JSON.stringify(o);var i=e("#"+a).data("sesskey");e.ajax({url:l.requestUrl,type:"GET",data:{action:"set_block_preferences_ajax",sesskey:i,data:o}}).done((function(e){})).fail((function(e){console.log(e),t.addNotification({message:e,type:"error"})})).always((function(){location.reload()}))}(d,i)}))})),o.on(n.hidden,(function(){a.destroy()})),a.show()}));else if("hide"==s){var c=e(this).data("hidden"),u=e(this);e.ajax({url:l.requestUrl,type:"GET",data:{action:"toggle_hide_block_ajax",sesskey:M.cfg.sesskey,data:JSON.stringify({blockname:d,hidden:c})}}).done((function(e){(e=JSON.parse(e)).success&&(c?(u.closest(".elucidsitereport-block").removeClass("block-hidden"),u.data("hidden",0),u.html("Hide Block")):(u.closest(".elucidsitereport-block").addClass("block-hidden"),u.data("Unhide Block")))})).fail((function(e){})).always((function(){}))}else"editcap"==s&&o.create({title:"Edit Block Capabilities",body:a.loadFragment("local_sitereport","get_blockscap_form",r,{blockname:d})}).done((function(o){var i=o.getRoot();o.modal.addClass("modal-dialog-centered modal-lg"),i.on(n.bodyRendered,(function(){var n=o.modal.find(".block-cap-form");o.modal.find("#menucapabilities").on("change",(function(t){t.preventDefault();var i=n.serializeArray(),l={};e(i).each((function(e,t){l[t.name]=t.value})),a.loadFragment("local_sitereport","block_overview_display",r,{capvalue:l.capabilities}).done((function(e,t,a){o.modal.find(".cap-overview").html(e),w(o)}))})),w(o),n=o.modal.find(".block-cap-form"),o.modal.find(".save-block-caps").on("click",(function(a){a.preventDefault();var i=n.serializeArray(),r={};e(i).each((function(e,t){r[t.name]=t.value})),function(a,o,n){o.blockname=a,o=JSON.stringify(o);var i=e("#"+a).data("sesskey");e.ajax({url:l.requestUrl,type:"GET",data:{action:"set_block_capability_ajax",sesskey:i,data:o}}).done((function(e){(e=JSON.parse(e)).success?(n(),location.reload()):t.addNotification({message:"Error",type:"error"})})).fail((function(e){console.log(e),t.addNotification({message:e,type:"error"})})).always((function(){n(),location.reload()}))}(d,r,(function(){o.destroy()}))}))})),i.on(n.hidden,(function(){o.destroy()})),o.show()}))})),function(t){t?(t=0,editingtxt="Stop Customising this page"):(t=1,editingtxt="Customise this page");var a='<div id="editing-btn" class="d-flex flex-wrap">';a+='<div class="ml-auto d-flex">',a+='<div class="singlebutton">',a+='<form method="post" action="'+M.cfg.wwwroot+'/local/sitereport/index.php">',a+='<input type="hidden" name="edit" value="'+t+'">',a+='<input type="hidden" name="sesskey" value="'+M.cfg.sesskey+'">',a+='<button type="submit" class="btn btn-secondary" title="">'+editingtxt+"</button>",a+="</form></div></div>",e("#page-local-sitereport-index #page-header .card-body").append(a)}(e("#wdm-elucidsitereport").data("editing"))}))}));