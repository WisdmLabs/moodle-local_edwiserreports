define(["jquery","core/chartjs","report_elucidsitereport/defaultconfig","report_elucidsitereport/variables","report_elucidsitereport/flatpickr"],function(t,a,l,n){var i=null,s=null,d=l.getPanel("#activeusersblock"),e=l.getPanel("#activeusersblock","body"),p=l.getPanel("#activeusersblock","title"),c=(l.getPanel("#activeusersblock","footer"),d+" .dropdown-menu[aria-labelledby='filter-dropdown']"),u=c+" .dropdown-item",g=d+" #filter-dropdown.dropdown-toggle",h=d+" #flatpickrCalender",m=e+" .ct-chart",f=e+" .loader",b=d+" button#filter-dropdown",C=p+" .refresh",v=d+n.exportUrlLink,k=null,y=p+" input.form-control.input",w=null;return{init:function(e){function o(e){t(m).hide(),t(f).show(),e=e||"weekly",t.ajax({url:l.requestUrl,data:{action:"get_activeusers_graph_data_ajax",sesskey:t(d).data("sesskey"),data:JSON.stringify({filter:e})}}).done(function(e){i.graph.data=e.data,i.graph.labels=e.labels}).fail(function(e){console.log(e)}).always(function(){s=function(){s&&s.destroy();return a.defaults.global.defaultFontFamily=i.graph.fontFamily,a.defaults.global.defaultFontStyle=i.graph.fontStyle,s=new a(i.ctx,{type:i.graph.type,data:function(){return{labels:i.graph.labels,datasets:[{label:i.graph.labelName.activeUsers,data:i.graph.data.activeUsers,backgroundColor:i.graph.backgroundColor.activeUsers,borderColor:i.graph.borderColor.activeUsers,pointBorderColor:i.graph.borderColor.activeUsers,pointBackgroundColor:i.graph.borderColor.activeUsers,pointStyle:i.graph.pointStyle},{label:i.graph.labelName.enrolments,data:i.graph.data.enrolments,backgroundColor:i.graph.backgroundColor.enrolments,borderColor:i.graph.borderColor.enrolments,pointBorderColor:i.graph.borderColor.enrolments,pointBackgroundColor:i.graph.borderColor.enrolments,pointStyle:i.graph.pointStyle},{label:i.graph.labelName.completionRate,data:i.graph.data.completionRate,backgroundColor:i.graph.backgroundColor.completionRate,borderColor:i.graph.borderColor.completionRate,pointBorderColor:i.graph.borderColor.completionRate,pointBackgroundColor:i.graph.borderColor.completionRate,pointStyle:i.graph.pointStyle}]}}(),options:i.graph.options})}(),n.changeExportUrl(e,v,n.filterReplaceFlag),t(p+" #updated-time > span.minute").html(0),setInterval(r,6e4),t(C).removeClass("refresh-spin"),t(f).hide(),t(m).fadeIn("slow"),w("activeUsers")})}function r(){t(p+" #updated-time > span.minute").html(parseInt(t(p+" #updated-time > span.minute").text())+1)}w=e,t(document).ready(function(){(i=l.getActiveUsersBlock())?(t(g).on("click",function(){t(c).addClass("show")}),t(y).ready(function(){var e=t(y).attr("placeholder");t(y).val(e)}),t(document).click(function(e){t(e.target).hasClass("dropdown-menu")||t(e.target).parents(".dropdown-menu").length||t(c).removeClass("show")}),t(u+":not(.custom)").on("click",function(){k=t(this).attr("value"),t(c).removeClass("show"),t(b).html(t(this).text()),o(k),t(h).val("Custom"),t(y).val("Custom")}),t(C).on("click",function(){t(this).addClass("refresh-spin"),o(k)}),s=o(),t(h).flatpickr({mode:"range",altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",maxDate:"today",appendTo:document.getElementById("activeUser-calendar"),onOpen:function(e){t(c).addClass("withcalendar")},onClose:function(){t(c).removeClass("withcalendar"),t(c).removeClass("show"),function(){k=t(h).val();var e=t(y).val();if(!k.includes("to"))return;l.changeExportUrl(k,v,n.filterReplaceFlag),t(b).html(e),t(h).val(""),o(k)}()}})):w("activeUsers")})}}});