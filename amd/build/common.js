define(["jquery","core/notification","core/fragment","core/modal_factory","core/modal_events","core/templates","core/str","report_elucidsitereport/variables","report_elucidsitereport/select2","report_elucidsitereport/jquery.dataTables","report_elucidsitereport/dataTables.bootstrap4"],function(i,r,a,o,n,d,l,s){var c=null,e="#scheduletab",u="button.dropdown-toggle",f=e+" input#esr-sendduration",t=e+" .dropdown:not(.duration-dropdown)",m=t+" button.dropdown-toggle",p=e+" .dropdown.daily-dropdown button.dropdown-toggle",g=e+" .dropdown.weekly-dropdown button.dropdown-toggle",h=e+" .dropdown.monthly-dropdown button.dropdown-toggle",b=e+" input#esr-sendtime",v='<div class="w-full text-center"><i class="fa fa-spinner fa-spin" aria-hidden="true"></i></div>',y='<div class="alert alert-danger"><b>ERROR:</b> Error while scheduling email<div>',w='<div class="alert alert-success"><b>Success:</b> Email scheduled successfully<div>',k='<div class="alert alert-success"><b>Success:</b> Email deleted successfully<div>',_='<div class="alert alert-danger"><b>ERROR:</b> Email deletion failed<div>',x='<div class="alert alert-danger"><b>ERROR:</b> Name and Recepient Fields can not be empty<div>',R='<div class="alert alert-danger"><b>ERROR:</b> Invalid email adderesses space not allowed<div>',S='[data-plugin="tabs"] .nav-link, [data-plugin="tabs"] .tab-pane',E='[aria-controls="scheduletab"], #scheduletab';function T(e,a){var t=a.getRoot().find("#esr-shceduled-emails");return i(document).on("click",'[aria-controls="listemailstab"]',function(){i(window).resize()}),t.DataTable({ajax:{url:s.requestUrl,type:s.requestType,data:{action:"get_scheduled_emails_ajax",sesskey:i(e).data("sesskey"),data:JSON.stringify({blockname:i(e).attr("data-blockname"),href:i(e).attr("href"),region:i(e).attr("data-region")})}},scrollY:"300px",scrollX:!0,scrollCollapse:!0,oLanguage:{sEmptyTable:"There is no scheduled emails"},language:{searchPlaceholder:"Search shceduled email"},order:[[1,"asc"]],columns:[{data:"esrtoggle",orderable:!1},{data:"esrname",orderable:!0},{data:"esrcomponent",orderable:!0},{data:"esrnextrun",orderable:!0},{data:"esrfrequency",orderable:!0},{data:"esrmanage",orderable:!1}],responsive:!0,bInfo:!1,lengthChange:!1,paging:!1})}function O(e){var a="#wdm-elucidsitereport > div";e<780?i(a).addClass("col-lg-12"):i(a).removeClass("col-lg-12"),i(a).find(".table.dataTable").DataTable().draw()}i(document).ready(function(){O(i("#page-admin-report-elucidsitereport-index .page-content").width()),i(window).on("resize",function(){O(s.pluginPage.width())}),i(document).on("click",'.export-dropdown a[data-action="email"]',function(e){e.preventDefault();var t=this;o.create({type:o.types.SAVE_CANCEL,title:"Email Dialog Box",body:a.loadFragment("report_elucidsitereport","email_dialog",i(t).data("contextid"),{blockname:i(t).data("blockname")})},i(this)).done(function(e){var a=e.getRoot();a.on(n.hidden,function(){e.destroy()}),a.on(n.save,function(){!function(e,a){i.ajax({url:e.href,type:"POST",data:a.find("form").serialize()}).done(function(e){(e=i.parseJSON(e)).error?r.addNotification({message:e.errormsg,type:"error"}):r.addNotification({message:"Email has been sent",type:"info"})}).fail(function(){r.addNotification({message:"Failed to send the email",type:"error"})})}(t,a)}),e.setSaveButtonText("Send"),e.show()})}),i(document).on("click",'.export-dropdown a[data-action="emailscheduled"]',function(e){e.preventDefault();var t=this,a=s.getScheduledEmailFormContext();o.create({title:"Schedule Emails",body:d.render("report_elucidsitereport/email_schedule_tabs",a)},i(this)).done(function(e){var a=e.getRoot();e.modal.addClass("modal-lg"),a.on(n.bodyRendered,function(){a.find("#esr-blockname").val(i(t).data("blockname")),a.find("#esr-region").val(i(t).data("region")),c=T(t,e)}),a.on(n.hidden,function(){e.destroy()}),function(e,o,n){o.on("click","#scheduletab .dropdown a.dropdown-item",function(){!function(e){var a=i(e).data("value"),t=i(e).text(),o=i(e).closest(".dropdown").find(u);o.text(t),o.data("value",a)}(this)}),o.on("click","#scheduletab .dropdown.duration-dropdown a.dropdown-item",function(){!function(e,a){var t=i(e).data("value");i(e).text();a.find(f).val(t),i(m).hide();var o=null;switch(t){case 1:o=i(g);break;case 2:o=i(h);break;default:o=i(p)}o.show();var n=o.data("value");i(b).val(n)}(this,o)}),o.on("click","#scheduletab .dropdown:not(.duration-dropdown) a.dropdown-item",function(){o.find(b).val(i(this).data("value"))}),o.on("click","#listemailstab .esr-email-sched-setting",function(){!function(e,a){var t=i(e).data("id"),o=i(e).data("blockname"),n=i(e).data("region");i.ajax({url:s.requestUrl,type:s.requestType,sesskey:i(e).data("sesskey"),data:{action:"get_scheduled_email_detail_ajax",sesskey:i(e).data("sesskey"),data:JSON.stringify({id:t,blockname:o,region:n})}}).done(function(e){e.error?console.log(e):(function(e,a,n){var r=null,d=null;i.each(e.data,function(e,a){if("object"==typeof a)n.find("#esr-blockname").val(a.blockname),n.find("#esr-region").val(a.region);else if("esrduration"===e){var t='[aria-labelledby="durationcount"] .dropdown-item[data-value="'+a+'"]';r=a,n.find(t).click()}else if("esrtime"===e)d=a;else if("esremailenable"===e){var o=i('input[name="'+e+'"]');a?o.prop("checked",!0):o.prop("checked",!1)}else i('[name="'+e+'"]').val(a)});var t='.dropdown-item[data-value="'+d+'"]',o=null;switch(r){case"1":o=i(".weekly-dropdown");break;case"2":o=i(".monthly-dropdown");break;default:o=i(".daily-dropdown")}o.find(t).click()}(e,0,a),a.find(S).removeClass("active show"),a.find(E).addClass("active show"))}).fail(function(e){console.log(e)})}(this,o)}),o.on("click","#listemailstab .esr-email-sched-delete",function(a){var t=this;l.get_strings([{key:"confirmemailremovaltitle",component:"report_elucidsitereport"},{key:"confirmemailremovalquestion",component:"report_elucidsitereport"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(e){r.confirm(e[0],e[1],e[2],e[3],i.proxy(function(){!function(a,e,t){var o=i(a).data("id"),n=i(a).data("blockname"),r=i(a).data("region"),d=e.find(".esr-form-error");d.html(v).show(),i.ajax({url:s.requestUrl,type:s.requestType,sesskey:i(a).data("sesskey"),data:{action:"delete_scheduled_email_ajax",sesskey:i(a).data("sesskey"),data:JSON.stringify({id:o,blockname:n,region:r})}}).done(function(e){e.error?d.html(_):(c&&c.destroy(),c=T(a,t),d.html(k))}).fail(function(e){d.html(_),console.log(e)}).always(function(){d.delay(3e3).fadeOut("slow")})}(t,o,n)},a.currentTarget))})}),o.on("change","#listemailstab [id^='esr-toggle-']",function(){!function(a,e,t){var o=i(a).data("id"),n=i(a).data("blockname"),r=i(a).data("region");i.ajax({url:s.requestUrl,type:s.requestType,sesskey:i(a).data("sesskey"),data:{action:"change_scheduled_email_status_ajax",sesskey:i(a).data("sesskey"),data:JSON.stringify({id:o,blockname:n,region:r})}}).done(function(e){e.error||(c&&c.destroy(),c=T(a,t),errorBox.html(w))})}(this,0,n)}),function(o,n,r){n.on("click",'[data-action="save"]',function(){var a=n.find(".esr-form-error");if(a.html(v).show(),function(e,a){var t=e.find('[name="esrname"]').val(),o=e.find('[name="esrrecepient"]').val();if(""==t||""==o)return a.html(x).show(),!1;return!!/^(\s?[^\s,]+@[^\s,]+\.[^\s,]+\s?,)*(\s?[^\s,]+@[^\s,]+\.[^\s,]+)$/g.test(o)||(a.html(R).show(),!1)}(n.find("form"),a)){var e=s.getUrlParams(o.href,"filter"),t=s.getUrlParams(o.href,"cohortid");i.ajax({url:M.cfg.wwwroot+"/report/elucidsitereport/download.php?format=emailscheduled&filter="+e+"&cohortid="+t,type:"POST",data:n.find("form").serialize()}).done(function(e){(e=i.parseJSON(e)).error?(a.html(y),console.log(e.error)):(c&&c.destroy(),c=T(o,r),a.html(w))}).fail(function(e){a.html(y),console.log(e)}).always(function(){a.delay(3e3).fadeOut("slow")})}}),n.on("click",'[data-action="cancel"]',function(){n.find('[name^=esr]:not(.d-none):not([id="esr-toggle-"])').val(""),n.find("#esr-id").val(-1)})}(e,o,n)}(t,a,e),e.show()})})})});