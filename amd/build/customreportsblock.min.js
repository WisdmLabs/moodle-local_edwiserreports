"use strict";define(["jquery","core/ajax","core/modal_factory","core/modal_events","core/templates","core/notification","local_edwiserreports/jquery.dataTables","local_edwiserreports/dataTables.bootstrap4"],function(e,t,s,o,r,a){var l=".field .custom-field-checkbox",n=".reports-filter-body .custom-field-select",d="#wdm-cohort-select",i="#wdm-course-select",c="#wdm-custom-reports-save",p="#wdm-customreports-save-form",m=null,u=null,h=M.util.get_string("savecustomreport","local_edwiserreports"),f=[],_=[],g=[],w=0,v={downloadenable:!0},C={selector:".reports-preview-body .reports-preview-content.loader",show:function(){e(this.selector).removeClass("d-none").addClass("d-flex")},hide:function(){e(this.selector).removeClass("d-flex").addClass("d-none")}},y={selector:".reports-preview-body .reports-preview-content",show:function(){e(this.selector+":not(.loader)").removeClass("d-none").addClass("d-flex"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),C.hide()},hide:function(){e(this.selector+":not(.loader)").removeClass("d-flex").addClass("d-none"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),C.show()},empty:function(){e(this.selector+".empty").removeClass("d-none").addClass("d-flex"),e(this.selector+":not(.empty)").removeClass("d-flex").addClass("d-none"),C.hide()}},b={selector:".reports-list-body .reports-list-content.loader",show:function(){e(this.selector).removeClass("d-none").addClass("d-flex")},hide:function(){e(this.selector).removeClass("d-flex").addClass("d-none")}},x={selector:".reports-list-body .reports-list-content",show:function(){e(this.selector+":not(.loader)").removeClass("d-none").addClass("d-flex"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),b.hide()},hide:function(){e(this.selector+":not(.loader)").removeClass("d-flex").addClass("d-none"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),b.show()},empty:function(){e(this.selector+".empty").removeClass("d-none").addClass("d-flex"),e(this.selector+":not(.empty)").removeClass("d-flex").addClass("d-none"),b.hide()}};function T(){f=[],g=[e(d).val()],_=[e(i).val()],e(l+":checked").each(function(){f.push(e(this).val())});var s=t.call([{methodname:"local_edwiserreports_get_customreports_data",args:{params:JSON.stringify({fields:f,cohorts:g,courses:_})}}]);0==f.length?(y.empty(),e(c).prop("disabled",!0)):(y.hide(),s[0].done(function(t){if(t.success){m&&(m.clear().destroy(),e("#cr-preview-table").html(""));var s=JSON.parse(t.data);m=e("#cr-preview-table").DataTable({columns:s.columns,data:s.reportsdata,bInfo:!1,bFilter:!1,searching:!1,lengthChange:!1,drawCallback:function(){e(".dataTables_paginate > .pagination").addClass("pagination-sm pull-right"),e(".dataTables_filter").addClass("pagination-sm pull-right")}})}}).always(function(){y.show(),e(c).prop("disabled",!1)}))}function N(){s.create({title:h,type:s.types.SAVE_CANCEL,body:r.render("local_edwiserreports/custom_reports_save_form",v)}).done(function(s){var r=s.getRoot();s.show(),r.on(o.save,function(o){o.preventDefault(),r.find("input").on("input",function(){e('[id^="id_error_crb"]').html("")});var l=e(p).serializeArray().reduce(function(e,t){return e[t.name]=t.value,e},{});(function(t){var s=!0;return""==t.reportname&&(e("#id_error_crb_reportname").html(M.util.get_string("emptyfullname","local_edwiserreports")).show(),s=!1),""==t.reportshortname&&(e("#id_error_crb_reportshortname").html(M.util.get_string("emptyshortname","local_edwiserreports")).show(),s=!1),/[ `!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/.test(t.reportshortname)&&(e("#id_error_crb_reportshortname").html(M.util.get_string("nospecialchar","local_edwiserreports")).show(),s=!1),s})(l)&&(l.querydata={selectedfield:f,cohorts:g,courses:_},t.call([{methodname:"local_edwiserreports_save_customreports_data",args:{params:JSON.stringify(l)}}])[0].done(function(t){t.success?(v=JSON.parse(t.reportsdata),console.log(v),e("#user-notifications .close").click(),a.addNotification({message:M.util.get_string("reportssavesuccess","local_edwiserreports"),type:"success"})):(e("#user-notifications .close").click(),a.addNotification({message:t.errormsg,type:"error"})),e("html, body").animate({scrollTop:0},"slow"),k(),s.destroy()}))})})}function k(){t.call([{methodname:"local_edwiserreports_get_customreports_list",args:{params:JSON.stringify({})}}])[0].done(function(t){var s=JSON.parse(t.data);console.log(s),t.success&&(0==s.length?x.empty():(u&&(u.clear().destroy(),e("#cr-list-table").html("")),(u=e("#cr-list-table").DataTable({columns:[{data:"sno",title:M.util.get_string("sno","local_edwiserreports")},{data:"fullname",title:M.util.get_string("reportname","local_edwiserreports")},{data:"shortname",title:M.util.get_string("reportshortname","local_edwiserreports")},{data:"createdby",title:M.util.get_string("createdby","local_edwiserreports")},{data:"datecreated",title:M.util.get_string("datecreated","local_edwiserreports")},{data:"managehtml",title:M.util.get_string("manage","local_edwiserreports")}],order:[[2,"asc"]],data:s,bInfo:!1,bFilter:!1,searching:!1,lengthChange:!1,drawCallback:function(){e(".dataTables_paginate > .pagination").addClass("pagination-sm pull-right"),e(".dataTables_filter").addClass("pagination-sm pull-right")}})).on("order.dt search.dt",function(){u.column(0,{search:"applied",order:"applied"}).nodes().each(function(e,t){e.innerHTML=t+1})}).draw(),x.show()))})}return{init:function(){e(document).ready(function(){e(l).on("change",function(){T()}),e(n).on("change",function(){T()}),e(c).on("click",function(){N()}),k(),(w=e("#wdm_custom_reports_id").val())&&(v.reportsid=w,v.fullname=e("#wdm_custom_reports_fullname").val(),v.shortname=e("#wdm_custom_reports_shortname").val(),v.downloadenable=e("#wdm_custom_reports_downloadenable").val(),T())})}}});
//# sourceMappingURL=customreportsblock.min.js.map
