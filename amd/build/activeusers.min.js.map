{"version":3,"sources":["activeusers.js"],"names":["define","$","ModalFactory","ModalEvents","Notification","Fragment","Templates","V","common","init","CONTEXTID","PageId","ActiveUsersTable","loader","ModalTrigger","dropdownToggle","dropdownMenu","dropdownItem","flatpickrCalender","dropdownButton","filter","cohortId","dropdownInput","sesskey","DataTable","cohortFilterBtn","cohortFilterItem","createModalOfUsersList","document","on","title","action","this","data","ModalRoot","titleDate","formatDate","Date","eval","M","util","get_string","component","date","create","body","loadFragment","page","cohortid","then","modal","getRoot","find","addClass","setTitle","show","hidden","destroy","bodyRendered","ModalTable","hasClass","empty","language","searchPlaceholder","emptyTable","drawCallback","bInfo","fail","exception","createDropdownCalendar","flatpickr","mode","altInput","altFormat","dateFormat","maxDate","appendTo","getElementById","onOpen","onClose","removeClass","selectedCustomDate","val","includes","html","createActiveUsersTable","hide","ajax","url","requestUrl","JSON","stringify","done","response","ActiveUsers","parse","each","labels","idx","parseInt","getTime","activeusers","activeUsers","courseenrolment","enrolments","coursecompletion","completionRate","context","render","js","replaceNode","ex","console","log","always","responsive","order","columnDefs","targets","className","info","error","ready","placeholder","attr","click","e","target","parents","length","text"],"mappings":"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","sourcesContent":["/* eslint-disable no-console */\r\ndefine([\r\n    'jquery',\r\n    'core/modal_factory',\r\n    'core/modal_events',\r\n    'core/notification',\r\n    'core/fragment',\r\n    'core/templates',\r\n    'local_edwiserreports/variables',\r\n    './common',\r\n    'local_edwiserreports/jquery.dataTables',\r\n    'local_edwiserreports/dataTables.bootstrap4',\r\n    'local_edwiserreports/flatpickr',\r\n    'local_edwiserreports/common'\r\n], function($, ModalFactory, ModalEvents, Notification, Fragment, Templates, V, common) {\r\n    /**\r\n     * Initialize\r\n     * @param {integer} CONTEXTID Current page context id\r\n     */\r\n    function init(CONTEXTID) {\r\n        var PageId = \"#wdm-activeusers-individual\";\r\n        var ActiveUsersTable = PageId + \" .table\";\r\n        var loader = PageId + \" .loader\";\r\n        var ModalTrigger = ActiveUsersTable + \" a\";\r\n        var dropdownToggle = \"#filter-dropdown.dropdown-toggle\";\r\n        var dropdownMenu = \".dropdown-menu[aria-labelledby='filter-dropdown']\";\r\n        var dropdownItem = dropdownMenu + \" .dropdown-item\";\r\n        var flatpickrCalender = \"#flatpickrCalender\";\r\n        var dropdownButton = \"button#filter-dropdown\";\r\n        var filter = 'weekly';\r\n        var cohortId = 0;\r\n        var dropdownInput = \"#wdm-userfilter input.form-control.input\";\r\n        var sesskey = null;\r\n        var DataTable = null;\r\n\r\n        // Varibales for cohort filter\r\n        var cohortFilterBtn = \"#cohortfilter\";\r\n        var cohortFilterItem = cohortFilterBtn + \" ~ .dropdown-menu .dropdown-item\";\r\n        // Var tableDom = '<\"row\"f><\"row\"t><\"row\"<\"d-none\"i><p>>';\r\n        $(document).ready(function() {\r\n            /* Show custom dropdown */\r\n            $(dropdownToggle).on(\"click\", function() {\r\n                $(dropdownMenu).addClass(\"show\");\r\n            });\r\n\r\n            /* Added Custom Value in Dropdown */\r\n            $(dropdownInput).ready(function() {\r\n                var placeholder = $(dropdownInput).attr(\"placeholder\");\r\n                $(dropdownInput).val(placeholder);\r\n            });\r\n\r\n            /* Hide dropdown when click anywhere in the screen */\r\n            $(document).click(function(e) {\r\n                if (!($(e.target).hasClass(\"dropdown-menu\") ||\r\n                    $(e.target).parents(\".dropdown-menu\").length)) {\r\n                    $(dropdownMenu).removeClass('show');\r\n                }\r\n            });\r\n\r\n            /* Select cohort filter for active users block */\r\n            $(cohortFilterItem).on('click', function() {\r\n                cohortId = $(this).data('cohortid');\r\n                $(cohortFilterBtn).html($(this).text());\r\n                $(PageId).find('.download-links input[name=\"cohortid\"]').val(cohortId);\r\n                createActiveUsersTable(filter, cohortId);\r\n            });\r\n\r\n            /* Select filter for active users block */\r\n            $(dropdownItem + \":not(.custom)\").on('click', function() {\r\n                filter = $(this).attr('value');\r\n                $(PageId).find('.download-links input[name=\"filter\"]').val(filter);\r\n                $(dropdownMenu).removeClass('show');\r\n                $(dropdownButton).html($(this).text());\r\n                createActiveUsersTable(filter, cohortId);\r\n                $(flatpickrCalender).val(\"Custom\");\r\n                $(dropdownInput).val(\"Custom\");\r\n            });\r\n\r\n            createActiveUsersTable();\r\n            createModalOfUsersList();\r\n            createDropdownCalendar();\r\n        });\r\n\r\n        /**\r\n         * Create modal of Users list\r\n         */\r\n        function createModalOfUsersList() {\r\n            $(document).on('click', ModalTrigger, function() {\r\n                var title = \"\";\r\n                var action = $(this).data(\"action\");\r\n                var filter = $(this).data(\"filter\");\r\n                var ModalRoot = null;\r\n\r\n                // eslint-disable-next-line no-eval\r\n                var titleDate = V.formatDate(new Date(eval(filter * 1000)), \"d MMM yyyy\");\r\n\r\n                if (action == \"activeusers\") {\r\n                    title = M.util.get_string('activeusersmodaltitle', V.component, {\r\n                        \"date\": titleDate\r\n                    });\r\n                } else if (action == \"enrolments\") {\r\n                    title = M.util.get_string('enrolmentsmodaltitle', V.component, {\r\n                        \"date\": titleDate\r\n                    });\r\n                } else if (action == \"completions\") {\r\n                    title = M.util.get_string('completionsmodaltitle', V.component, {\r\n                        \"date\": titleDate\r\n                    });\r\n                }\r\n\r\n                ModalFactory.create({\r\n                    body: Fragment.loadFragment(\r\n                        'local_edwiserreports',\r\n                        'userslist',\r\n                        CONTEXTID,\r\n                        {\r\n                            page: 'activeusers',\r\n                            filter: filter,\r\n                            cohortid: cohortId,\r\n                            action: action\r\n                        }\r\n                    )\r\n                }).then(function(modal) {\r\n                    ModalRoot = modal.getRoot();\r\n                    ModalRoot.find('.modal-dialog').addClass('modal-lg');\r\n                    modal.setTitle(title);\r\n                    modal.show();\r\n                    ModalRoot.on(ModalEvents.hidden, function() {\r\n                        modal.destroy();\r\n                    });\r\n\r\n                    ModalRoot.on(ModalEvents.bodyRendered, function() {\r\n                        var ModalTable = ModalRoot.find(\".modal-table\");\r\n\r\n                        // If empty then remove colspan\r\n                        if (ModalTable.find(\"tbody\").hasClass(\"empty\")) {\r\n                            ModalTable.find(\"tbody\").empty();\r\n                        }\r\n\r\n                        // Create dataTable for userslist\r\n                        ModalRoot.find(\".modal-table\").DataTable({\r\n                            language: {\r\n                                searchPlaceholder: \"Search User\",\r\n                                emptyTable: \"There are no users\"\r\n                            },\r\n                            drawCallback: function() {\r\n                                $('.dataTables_paginate > .pagination').addClass('pagination-sm pull-right');\r\n                                $('.dataTables_filter').addClass('pagination-sm pull-right');\r\n                            },\r\n                            // ScrollY : \"350px\",\r\n                            // scrollX : true,\r\n                            // paging: false,\r\n                            bInfo: false\r\n                        });\r\n                    });\r\n                    return;\r\n                }).fail(Notification.exception);\r\n            });\r\n        }\r\n\r\n        /**\r\n         * Create Calender in dropdown tp select range.\r\n         */\r\n        function createDropdownCalendar() {\r\n            $(flatpickrCalender).flatpickr({\r\n                mode: 'range',\r\n                altInput: true,\r\n                altFormat: \"d/m/Y\",\r\n                dateFormat: \"Y-m-d\",\r\n                maxDate: \"today\",\r\n                appendTo: document.getElementById(\"activeUser-calendar\"),\r\n                onOpen: function() {\r\n                    $(dropdownMenu).addClass('withcalendar');\r\n                },\r\n                onClose: function() {\r\n                    $(dropdownMenu).removeClass('withcalendar');\r\n                    $(dropdownMenu).removeClass('show');\r\n                    selectedCustomDate();\r\n                }\r\n            });\r\n        }\r\n\r\n        /**\r\n         * After Select Custom date get active users details.\r\n         */\r\n        function selectedCustomDate() {\r\n            filter = $(flatpickrCalender).val();\r\n            var date = $(dropdownInput).val();\r\n\r\n            /* If correct date is not selected then return false */\r\n            if (!filter.includes(\"to\")) {\r\n                return;\r\n            }\r\n\r\n            $(dropdownButton).html(date);\r\n            $(flatpickrCalender).val(\"\");\r\n            $(PageId).find('.download-links input[name=\"filter\"]').val(filter);\r\n            createActiveUsersTable(filter, cohortId);\r\n        }\r\n\r\n        /**\r\n         * Create Active Users Table.\r\n         * @param {string} filter Filter string.\r\n         * @param {integer} cohortId Integer string.\r\n         */\r\n        function createActiveUsersTable(filter, cohortId) {\r\n            sesskey = $(PageId).data(\"sesskey\");\r\n\r\n            /* If datatable is already created then destroy the table */\r\n            if (DataTable) {\r\n                DataTable.destroy();\r\n                $(ActiveUsersTable).hide();\r\n                $(loader).show();\r\n            }\r\n\r\n            // Show loader.\r\n            common.loader.show(\"#wdm-activeusers-individual\");\r\n\r\n            $.ajax({\r\n                url: V.requestUrl,\r\n                data: {\r\n                    action: 'get_activeusers_graph_data_ajax',\r\n                    sesskey: sesskey,\r\n                    data: JSON.stringify({\r\n                        filter: filter,\r\n                        cohortid: cohortId\r\n                    })\r\n                },\r\n            }).done(function(response) {\r\n                var ActiveUsers = [];\r\n                response = JSON.parse(response);\r\n\r\n                $.each(response.labels, function(idx, val) {\r\n                    ActiveUsers[idx] = {\r\n                        date: val,\r\n                        filter: parseInt((new Date(val).getTime() / 1000)),\r\n                        activeusers: response.data.activeUsers[idx],\r\n                        courseenrolment: response.data.enrolments[idx],\r\n                        coursecompletion: response.data.completionRate[idx]\r\n                    };\r\n                });\r\n\r\n                var context = {\r\n                    activeusers: ActiveUsers,\r\n                    sesskey: sesskey\r\n                };\r\n\r\n                // eslint-disable-next-line promise/catch-or-return\r\n                Templates.render('local_edwiserreports/activeuserstable', context)\r\n                .then(function(html, js) {\r\n                    Templates.replaceNode(ActiveUsersTable, html, js);\r\n                    return;\r\n                }).fail(function(ex) {\r\n                    console.log(ex);\r\n                }).always(function() {\r\n                    DataTable = $(ActiveUsersTable).DataTable({\r\n                        responsive: true,\r\n                        // Dom : '<\"pull-left\"f><t><p>',\r\n                        order: [[0, 'desc']],\r\n                        language: {\r\n                            searchPlaceholder: \"Search Date\",\r\n                            emptyTable: \"There are no active users\"\r\n                        },\r\n                        columnDefs: [\r\n                            {\r\n                                \"targets\": 0,\r\n                                \"className\": \"text-left\"\r\n                            },\r\n                            {\r\n                                \"targets\": \"_all\",\r\n                                \"className\": \"text-center\",\r\n                            }\r\n                        ],\r\n                        info: false,\r\n                        drawCallback: function() {\r\n                            $('.dataTables_paginate > .pagination').addClass('pagination-sm pull-right');\r\n                            $('.dataTables_filter').addClass('pagination-sm pull-right');\r\n                        }\r\n                        // ScrollY : 350,\r\n                        // scrollX : true,\r\n                        // paginate : false\r\n                    });\r\n                    $(ActiveUsersTable).show();\r\n                    $(loader).hide();\r\n\r\n                    // Hide loader.\r\n                    common.loader.hide(\"#wdm-activeusers-individual\");\r\n                });\r\n            }).fail(function(error) {\r\n                console.log(error);\r\n                // Hide loader.\r\n                common.loader.hide(\"#wdm-activeusers-individual\");\r\n            });\r\n        }\r\n    }\r\n    return {\r\n        init: init\r\n    };\r\n\r\n});\r\n"],"file":"activeusers.min.js"}