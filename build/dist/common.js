define(["jquery","core/notification","core/fragment","core/modal_factory","core/modal_events","core/templates","core/str","report_elucidsitereport/variables","report_elucidsitereport/jspdf","report_elucidsitereport/select2","report_elucidsitereport/jquery.dataTables","report_elucidsitereport/dataTables.bootstrap4"],function(c,n,a,t,r,d,u,f,o){var m=null,e="#scheduletab",i="button.dropdown-toggle",p=e+" input#esr-sendduration",l=e+" .dropdown:not(.duration-dropdown)",h=l+" button.dropdown-toggle",g=e+" .dropdown.daily-dropdown button.dropdown-toggle",v=e+" .dropdown.weekly-dropdown button.dropdown-toggle",b=e+" .dropdown.monthly-dropdown button.dropdown-toggle",y=e+" input#esr-sendtime",w='<div class="w-full text-center"><i class="fa fa-spinner fa-spin" aria-hidden="true"></i></div>',k='<div class="alert alert-danger"><b>ERROR:</b> Error while scheduling email<div>',_='<div class="alert alert-success"><b>Success:</b> Email scheduled successfully<div>',x='<div class="alert alert-success"><b>Success:</b> Email deleted successfully<div>',R='<div class="alert alert-danger"><b>ERROR:</b> Email deletion failed<div>',S='<div class="alert alert-danger"><b>ERROR:</b> Name and Recepient Fields can not be empty<div>',T='<div class="alert alert-danger"><b>ERROR:</b> Invalid email adderesses space not allowed<div>',j='[data-plugin="tabs"] .nav-link, [data-plugin="tabs"] .tab-pane',O='[aria-controls="scheduletab"], #scheduletab';function E(e,a){var t=a.getRoot().find("#esr-shceduled-emails");return c(document).on("click",'[aria-controls="listemailstab"]',function(){c(window).resize()}),t.DataTable({ajax:{url:f.requestUrl,type:f.requestType,data:{action:"get_scheduled_emails_ajax",sesskey:c(e).data("sesskey"),data:JSON.stringify({blockname:c(e).attr("data-blockname"),href:c(e).attr("href"),region:c(e).attr("data-region")})}},scrollY:"300px",scrollX:!0,scrollCollapse:!0,language:{searchPlaceholder:"Search shceduled email",emptyTable:"There is no scheduled emails"},order:[[1,"asc"]],columns:[{data:"esrtoggle",orderable:!1},{data:"esrname",orderable:!0},{data:"esrcomponent",orderable:!0},{data:"esrnextrun",orderable:!0},{data:"esrfrequency",orderable:!0},{data:"esrmanage",orderable:!1}],responsive:!0,bInfo:!1,lengthChange:!1,paging:!1})}function s(e){var a="#wdm-elucidsitereport > div";e<780?c(a).addClass("col-lg-12"):c(a).removeClass("col-lg-12"),c(a).find(".table.dataTable").DataTable().draw()}c(document).ready(function(){s(c("#page-admin-report-elucidsitereport-index .page-content").width()),c(window).on("resize",function(){s(f.pluginPage.width())}),c(document).on("click",'.export-dropdown a[data-action="pdf"]',function(e){e.preventDefault(),c(document).find("#cover-spin")&&c("body").append('<div id="cover-spin"></div>'),c(document).find("#cover-spin").show(0);c.ajax({url:this.href}).done(function(a){a=JSON.parse(a);var t=new o("p","pt","a4"),e={top:40,bottom:30,left:10,width:"100%"};t.setFontSize(10);t.fromHTML(a.data.html,e.left,e.top,{width:e.width,elementHandlers:{"#bypassme":function(e,a){return!0}}},function(e){t.save(a.data.filename)},e)}).always(function(){c(document).find("#cover-spin").hide()})}),c(document).on("click",'.export-dropdown a[data-action="email"]',function(e){e.preventDefault();var o=this;t.create({type:t.types.SAVE_CANCEL,title:f.getEmailModalHeader(c(o).data("blockname"),0),body:a.loadFragment("report_elucidsitereport","email_dialog",c(o).data("contextid"),{blockname:c(o).data("blockname")})},c(this)).done(function(e){var t=e.getRoot();t.on(r.hidden,function(){e.destroy()}),t.on(r.save,function(){var e,a;e=o,a=t,c.ajax({url:e.href,type:"POST",data:a.find("form").serialize()}).done(function(e){(e=c.parseJSON(e)).error?n.addNotification({message:e.errormsg,type:"error"}):n.addNotification({message:"Email has been sent",type:"info"})}).fail(function(){n.addNotification({message:"Failed to send the email",type:"error"})})}),e.setSaveButtonText("Send"),e.show()})}),c(document).on("click",'.export-dropdown a[data-action="emailscheduled"]',function(e){e.preventDefault();var o=this,a=f.getScheduledEmailFormContext();t.create({title:f.getEmailModalHeader(c(o).data("blockname"),1),body:d.render("report_elucidsitereport/email_schedule_tabs",a)},c(this)).done(function(e){var a,l,s,t=e.getRoot();e.modal.addClass("modal-lg"),t.on(r.bodyRendered,function(){t.find("#esr-blockname").val(c(o).data("blockname")),t.find("#esr-region").val(c(o).data("region")),m=E(o,e)}),t.on(r.hidden,function(){e.destroy()}),a=o,s=e,(l=t).on("click","#scheduletab .dropdown a.dropdown-item",function(){var e,a,t,o;a=c(e=this).data("value"),t=c(e).text(),(o=c(e).closest(".dropdown").find(i)).text(t),o.data("value",a)}),l.on("click","#scheduletab .dropdown.duration-dropdown a.dropdown-item",function(){!function(e,a){var t=c(e).data("value");c(e).text();a.find(p).val(t),c(h).hide();var o=null;switch(t){case 1:o=c(v);break;case 2:o=c(b);break;default:o=c(g)}o.show();var n=o.data("value");c(y).val(n)}(this,l)}),l.on("click","#scheduletab .dropdown:not(.duration-dropdown) a.dropdown-item",function(){l.find(y).val(c(this).data("value"))}),l.on("click","#listemailstab .esr-email-sched-setting",function(){var e,a,t,o,n;a=l,t=c(e=this).data("id"),o=c(e).data("blockname"),n=c(e).data("region"),c.ajax({url:f.requestUrl,type:f.requestType,sesskey:c(e).data("sesskey"),data:{action:"get_scheduled_email_detail_ajax",sesskey:c(e).data("sesskey"),data:JSON.stringify({id:t,blockname:o,region:n})}}).done(function(e){e.error?console.log(e):(function(e,n){var r=null,d=null;c.each(e.data,function(e,a){if("object"==typeof a)n.find("#esr-blockname").val(a.blockname),n.find("#esr-region").val(a.region);else if("esrduration"===e){var t='[aria-labelledby="durationcount"] .dropdown-item[data-value="'+a+'"]';r=a,n.find(t).click()}else if("esrtime"===e)d=a;else if("esremailenable"===e){var o=c('input[name="'+e+'"]');a?o.prop("checked",!0):o.prop("checked",!1)}else c('[name="'+e+'"]').val(a)});var a='.dropdown-item[data-value="'+d+'"]',t=null;switch(r){case"1":t=c(".weekly-dropdown");break;case"2":t=c(".monthly-dropdown");break;default:t=c(".daily-dropdown")}t.find(a).click()}(e,a),a.find(j).removeClass("active show"),a.find(O).addClass("active show"))}).fail(function(e){console.log(e)})}),l.on("click","#listemailstab .esr-email-sched-delete",function(a){var i=this;u.get_strings([{key:"confirmemailremovaltitle",component:"report_elucidsitereport"},{key:"confirmemailremovalquestion",component:"report_elucidsitereport"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(e){n.confirm(e[0],e[1],e[2],e[3],c.proxy(function(){var a,e,t,o,n,r,d;e=l,t=s,o=c(a=i).data("id"),n=c(a).data("blockname"),r=c(a).data("region"),(d=e.find(".esr-form-error")).html(w).show(),c.ajax({url:f.requestUrl,type:f.requestType,sesskey:c(a).data("sesskey"),data:{action:"delete_scheduled_email_ajax",sesskey:c(a).data("sesskey"),data:JSON.stringify({id:o,blockname:n,region:r})}}).done(function(e){e.error?d.html(R):(m&&m.destroy(),m=E(a,t),d.html(x))}).fail(function(e){d.html(R),console.log(e)}).always(function(){d.delay(3e3).fadeOut("slow")})},a.currentTarget))})}),l.on("change","#listemailstab [id^='esr-toggle-']",function(){var a,t,e,o,n;t=s,e=c(a=this).data("id"),o=c(a).data("blockname"),n=c(a).data("region"),c.ajax({url:f.requestUrl,type:f.requestType,sesskey:c(a).data("sesskey"),data:{action:"change_scheduled_email_status_ajax",sesskey:c(a).data("sesskey"),data:JSON.stringify({id:e,blockname:o,region:n})}}).done(function(e){e.error||(m&&m.destroy(),m=E(a,t),errorBox.html(_))})}),function(o,n,r){n.on("click",'[data-action="save"]',function(){var a=n.find(".esr-form-error");if(a.html(w).show(),function(e,a){var t=e.find('[name="esrname"]').val(),o=e.find('[name="esrrecepient"]').val();if(""==t||""==o)return a.html(S).show(),!1;return!!/^(\s?[^\s,]+@[^\s,]+\.[^\s,]+\s?,)*(\s?[^\s,]+@[^\s,]+\.[^\s,]+)$/g.test(o)||(a.html(T).show(),!1)}(n.find("form"),a)){var e=f.getUrlParams(o.href,"filter"),t=f.getUrlParams(o.href,"cohortid");c.ajax({url:M.cfg.wwwroot+"/report/elucidsitereport/download.php?format=emailscheduled&filter="+e+"&cohortid="+t,type:"POST",data:n.find("form").serialize()}).done(function(e){(e=c.parseJSON(e)).error?(a.html(k),console.log(e.error)):(m&&m.destroy(),m=E(o,r),a.html(_))}).fail(function(e){a.html(k),console.log(e)}).always(function(){a.delay(3e3).fadeOut("slow")})}}),n.on("click",'[data-action="cancel"]',function(){n.find('[name^=esr]:not(.d-none):not([id="esr-toggle-"])').val(""),n.find("#esr-id").val(-1)})}(a,l,s),e.show()})})})});