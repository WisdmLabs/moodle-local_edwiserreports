define(["jquery","core/modal_factory","core/modal_events","core/fragment","core/templates","local_sitereport/variables","local_sitereport/jquery.dataTables","local_sitereport/dataTables.bootstrap4","local_sitereport/flatpickr","local_sitereport/common"],(function($,ModalFactory,ModalEvents,Fragment,Templates,V){function init(CONTEXTID){var PageId="#wdm-activeusers-individual",ActiveUsersTable=PageId+" .table",loader=PageId+" .loader",ModalTrigger=ActiveUsersTable+" a",dropdownToggle="#filter-dropdown.dropdown-toggle",dropdownMenu=".dropdown-menu[aria-labelledby='filter-dropdown']",dropdownItem=dropdownMenu+" .dropdown-item",flatpickrCalender="#flatpickrCalender",dropdownButton="button#filter-dropdown",filter="weekly",cohortId=0,dropdownInput="#wdm-userfilter input.form-control.input",sesskey=null,DataTable=null,exportUrlLink=".dropdown-menu[aria-labelledby='export-dropdown'] .dropdown-item",cohortFilterBtn="#cohortfilter",cohortFilterItem=cohortFilterBtn+" ~ .dropdown-menu .dropdown-item";function createModalOfUsersList(){$(document).on("click",ModalTrigger,(function(){var title="",action=$(this).data("action"),filter=$(this).data("filter"),ModalRoot=null,titleDate=V.formatDate(new Date(eval(1e3*filter)),"d MMM yyyy");"activeusers"==action?title=M.util.get_string("activeusersmodaltitle",V.component,{date:titleDate}):"enrolments"==action?title=M.util.get_string("enrolmentsmodaltitle",V.component,{date:titleDate}):"completions"==action&&(title=M.util.get_string("completionsmodaltitle",V.component,{date:titleDate})),ModalFactory.create({body:Fragment.loadFragment("local_sitereport","userslist",CONTEXTID,{page:"activeusers",filter:filter,cohortid:cohortId,action:action})}).then((function(e){ModalRoot=e.getRoot(),e.setTitle(title),e.show(),ModalRoot.on(ModalEvents.hidden,(function(){e.destroy()})),ModalRoot.on(ModalEvents.bodyRendered,(function(){var e=ModalRoot.find(".modal-table");e.find("tbody").hasClass("empty")&&e.find("tbody").empty(),ModalRoot.find(".modal-table").DataTable({language:{searchPlaceholder:"Search users",emptyTable:"There are no users"},drawCallback:function(){$(".dataTables_paginate > .pagination").addClass("pagination-sm pull-right"),$(".dataTables_filter").addClass("pagination-sm pull-right")},bInfo:!1})}))}))}))}function createDropdownCalendar(){$(flatpickrCalender).flatpickr({mode:"range",altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",maxDate:"today",appendTo:document.getElementById("activeUser-calendar"),onOpen:function(e){$(dropdownMenu).addClass("withcalendar")},onClose:function(){$(dropdownMenu).removeClass("withcalendar"),$(dropdownMenu).removeClass("show"),selectedCustomDate()}})}function selectedCustomDate(){filter=$(flatpickrCalender).val();var e=$(dropdownInput).val();if(!filter.includes("to"))return!1;$(dropdownButton).html(e),$(flatpickrCalender).val(""),$(PageId).find('.download-links input[name="filter"]').val(filter),createActiveUsersTable(filter,cohortId)}function createActiveUsersTable(e,t){sesskey=$(PageId).data("sesskey"),DataTable&&(DataTable.destroy(),$(ActiveUsersTable).hide(),$(loader).show()),$.ajax({url:V.requestUrl,data:{action:"get_activeusers_graph_data_ajax",sesskey:sesskey,data:JSON.stringify({filter:e,cohortid:t})}}).done((function(e){var t=[];e=JSON.parse(e),$.each(e.labels,(function(a,o){t[a]={date:o,filter:parseInt(new Date(o).getTime()/1e3),activeusers:e.data.activeUsers[a],courseenrolment:e.data.enrolments[a],coursecompletion:e.data.completionRate[a]}}));var a={activeusers:t,sesskey:sesskey};Templates.render("local_sitereport/activeuserstable",a).then((function(e,t){Templates.replaceNode(ActiveUsersTable,e,t)})).fail((function(e){console.log(e)})).always((function(){DataTable=$(ActiveUsersTable).DataTable({responsive:!0,order:[[0,"desc"]],columnDefs:[{targets:0,className:"text-left"},{targets:"_all",className:"text-center"}],info:!1,drawCallback:function(){$(".dataTables_paginate > .pagination").addClass("pagination-sm pull-right"),$(".dataTables_filter").addClass("pagination-sm pull-right")}}),$(ActiveUsersTable).show(),$(loader).hide()}))})).fail((function(e){console.log(e)}))}$(document).ready((function(){$(dropdownToggle).on("click",(function(){$(dropdownMenu).addClass("show")})),$(dropdownInput).ready((function(){var e=$(dropdownInput).attr("placeholder");$(dropdownInput).val(e)})),$(document).click((function(e){$(e.target).hasClass("dropdown-menu")||$(e.target).parents(".dropdown-menu").length||$(dropdownMenu).removeClass("show")})),$(cohortFilterItem).on("click",(function(){cohortId=$(this).data("cohortid"),$(cohortFilterBtn).html($(this).text()),$(PageId).find('.download-links input[name="cohortid"]').val(cohortId),createActiveUsersTable(filter,cohortId)})),$(dropdownItem+":not(.custom)").on("click",(function(){filter=$(this).attr("value"),$(PageId).find('.download-links input[name="filter"]').val(filter),$(dropdownMenu).removeClass("show"),$(dropdownButton).html($(this).text()),createActiveUsersTable(filter,cohortId),$(flatpickrCalender).val("Custom"),$(dropdownInput).val("Custom")})),createActiveUsersTable(),createModalOfUsersList(),createDropdownCalendar()}))}return{init:init}}));