define(["jquery","core/chartjs","local_sitereport/defaultconfig","local_sitereport/variables","local_sitereport/flatpickr"],(function(e,o,t,a){var r=null,l=null,n=t.getPanel("#activeusersblock"),s=t.getPanel("#activeusersblock","body"),i=t.getPanel("#activeusersblock","title"),d=t.getPanel("#activeusersblock","footer"),c=n+" .dropdown-menu[aria-labelledby='filter-dropdown']:not('custom')",p=c+" .dropdown-item",u=n+" #filter-dropdown.dropdown-toggle",g=n+" #flatpickrCalender",h=s+" .ct-chart",m=s+" .loader",f=n+" button#filter-dropdown",b=i+" .refresh",C=n+a.exportUrlLink,v=null,k=i+" input.form-control.input",y=null;return{init:function(s){function w(a){e(h).hide(),e(m).show(),a||(a="weekly"),e.ajax({url:t.requestUrl,data:{action:"get_activeusers_graph_data_ajax",sesskey:e(n).data("sesskey"),data:JSON.stringify({filter:a})}}).done((function(e){e=JSON.parse(e),r.graph.data=e.data,r.graph.labels=e.labels})).fail((function(e){console.log(e)})).always((function(){l=function(){l&&l.destroy();return o.defaults.global.defaultFontFamily=r.graph.fontFamily,o.defaults.global.defaultFontStyle=r.graph.fontStyle,l=new o(r.ctx,{type:r.graph.type,data:S(),options:r.graph.options})}(),e(d).find('.download-links input[name="filter"]').val(a),e(i+" #updated-time > span.minute").html(0),setInterval(U,6e4),e(b).removeClass("refresh-spin"),e(m).hide(),e(h).fadeIn("slow"),y("activeUsers")}))}function U(){e(i+" #updated-time > span.minute").html(parseInt(e(i+" #updated-time > span.minute").text())+1)}function S(){return{labels:r.graph.labels,datasets:[{label:r.graph.labelName.activeUsers,data:r.graph.data.activeUsers,backgroundColor:r.graph.backgroundColor.activeUsers,borderColor:r.graph.borderColor.activeUsers,pointBorderColor:r.graph.borderColor.activeUsers,pointBackgroundColor:r.graph.borderColor.activeUsers,pointStyle:r.graph.pointStyle},{label:r.graph.labelName.enrolments,data:r.graph.data.enrolments,backgroundColor:r.graph.backgroundColor.enrolments,borderColor:r.graph.borderColor.enrolments,pointBorderColor:r.graph.borderColor.enrolments,pointBackgroundColor:r.graph.borderColor.enrolments,pointStyle:r.graph.pointStyle},{label:r.graph.labelName.completionRate,data:r.graph.data.completionRate,backgroundColor:r.graph.backgroundColor.completionRate,borderColor:r.graph.borderColor.completionRate,pointBorderColor:r.graph.borderColor.completionRate,pointBackgroundColor:r.graph.borderColor.completionRate,pointStyle:r.graph.pointStyle}]}}y=s,e(document).ready((function(){(r=t.getActiveUsersBlock())?(e(u).on("click",(function(){e(c).addClass("show")})),e(k).ready((function(){var o=e(k).attr("placeholder");e(k).val(o)})),e(document).click((function(o){e(o.target).hasClass("dropdown-menu")||e(o.target).parents(".dropdown-menu").length||e(c).removeClass("show")})),e(p+":not(.custom)").on("click",(function(){console.log(this),v=e(this).attr("value"),e(c).removeClass("show"),e(f).html(e(this).text()),w(v),e(g).val("Custom"),e(k).val("Custom")})),e(b).on("click",(function(){e(this).addClass("refresh-spin"),w(v)})),l=w(),e(g).flatpickr({mode:"range",altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",maxDate:"today",appendTo:document.getElementById("activeUser-calendar"),onOpen:function(o){e(c).addClass("withcalendar")},onClose:function(){e(c).removeClass("withcalendar"),e(c).removeClass("show"),function(){v=e(g).val();var o=e(k).val();if(!v.includes("to"))return!1;t.changeExportUrl(v,C,a.filterReplaceFlag),e(f).html(o),e(g).val(""),w(v)}()}})):y("activeUsers")}))}}}));