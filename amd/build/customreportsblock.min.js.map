{"version":3,"sources":["customreportsblock.js"],"names":["define","$","ajax","modalFactory","modalEvents","templates","notif","cfCheckbox","cfSelect","cfCohort","cfCourse","cfSave","cfSaveForm","cfPreviewTable","customReportSaveTitle","M","util","get_string","selectedFields","courses","cohorts","cfPreviewLoader","selector","show","this","removeClass","addClass","hide","cfPreview","empty","getCustomReportsData","val","each","push","call","methodname","args","params","JSON","stringify","fields","length","prop","done","response","success","clear","destroy","html","data","parse","DataTable","columns","reportsdata","bInfo","bFilter","searching","lengthChange","drawCallback","always","customReportServiceInit","on","create","title","type","types","SAVE_CANCEL","body","render","modal","root","getRoot","save","e","preventDefault","find","serializeArray","reduce","obj","item","name","value","ret","reportname","reportshortname","test","validateCustomReprtsSaveData","querydata","selectedfield","addNotification","message","errormsg","animate","scrollTop","init","document","ready"],"mappings":"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","sourcesContent":["define([\n    'jquery',\n    'core/ajax',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/templates',\n    'core/notification',\n    'local_edwiserreports/jquery.dataTables',\n    'local_edwiserreports/dataTables.bootstrap4'\n], function (\n    $,\n    ajax,\n    modalFactory,\n    modalEvents,\n    templates,\n    notif\n) {\n    'use strict';\n\n    // Field group checkbox\n    var cfCheckbox = '.field .custom-field-checkbox';\n    var cfSelect = '.reports-filter-body .custom-field-select';\n    var cfCohort = '#wdm-cohort-select';\n    var cfCourse = '#wdm-course-select';\n    var cfSave = '#wdm-custom-reports-save';\n    var cfSaveForm = '#wdm-customreports-save-form';\n    var cfPreviewTable = null;\n    var customReportSaveTitle = M.util.get_string('savecustomreport', 'local_edwiserreports');\n\n    var selectedFields = [];\n    var courses = [];\n    var cohorts = [];\n\n    var cfPreviewLoader = {\n        selector : '.reports-preview-body .reports-preview-content.loader',\n\n        show : function() {\n            $(this.selector).removeClass('d-none').addClass('d-flex');\n        },\n\n        hide : function() {\n            $(this.selector).removeClass('d-flex').addClass('d-none');\n        }\n    }\n\n    var cfPreview = {\n        selector : '.reports-preview-body .reports-preview-content',\n\n        show : function() {\n            $(this.selector + ':not(.loader)').removeClass('d-none').addClass('d-flex');\n            $(this.selector + '.empty').removeClass('d-flex').addClass('d-none');\n            cfPreviewLoader.hide();\n        },\n\n        hide : function() {\n            $(this.selector + ':not(.loader)').removeClass('d-flex').addClass('d-none');\n            $(this.selector + '.empty').removeClass('d-flex').addClass('d-none');\n            cfPreviewLoader.show();\n        },\n\n        empty : function() {\n            $(this.selector + '.empty').removeClass('d-none').addClass('d-flex');\n            $(this.selector + ':not(.empty)').removeClass('d-flex').addClass('d-none');\n            cfPreviewLoader.hide();\n        }\n    }\n\n    function getCustomReportsData() {\n        selectedFields = []\n        cohorts = [$(cfCohort).val()];\n        courses = [$(cfCourse).val()];\n        $(cfCheckbox + \":checked\").each(function() {\n            selectedFields.push($(this).val());\n        });\n\n        var getCustomReportsData = ajax.call([{\n            methodname: 'local_edwiserreports_get_customreports_data',\n            args: {\n                params: JSON.stringify({\n                    fields : selectedFields,\n                    cohorts : cohorts,\n                    courses : courses\n                })\n            }\n        }]);\n\n        if (selectedFields.length == 0) {\n            cfPreview.empty();\n            $(cfSave).prop('disabled', true);\n        } else {\n            cfPreview.hide();\n            getCustomReportsData[0].done(function(response) {\n                if (response.success) {\n                    if (cfPreviewTable) {\n                        cfPreviewTable.clear().destroy();\n                        $('#cr-preview-table').html('');\n                    }\n\n                    var data = JSON.parse(response.data);\n                    cfPreviewTable = $('#cr-preview-table').DataTable({\n                        columns: data.columns,\n                        data: data.reportsdata,\n                        bInfo: false,\n                        bFilter: false,\n                        searching: false,\n                        lengthChange: false,\n                        drawCallback: function() {\n                            $('.dataTables_paginate > .pagination').addClass('pagination-sm pull-right');\n                            $('.dataTables_filter').addClass('pagination-sm pull-right');\n                        }\n                    });\n                }\n            }).always(function() {\n                cfPreview.show();\n                $(cfSave).prop('disabled', false);\n            });\n        }\n    }\n\n    function validateCustomReprtsSaveData(data) {\n        var ret = true;\n        if (data.reportname == '') {\n            $('#id_error_crb_reportname')\n                .html(M.util.get_string('emptyfullname', 'local_edwiserreports'))\n                .show();\n            ret = false;\n        }\n\n        if (data.reportshortname == '') {\n            $('#id_error_crb_reportshortname')\n                .html(M.util.get_string('emptyshortname', 'local_edwiserreports'))\n                .show();\n            ret = false;\n        }\n\n        var format = /[ `!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?~]/;\n        if (format.test(data.reportshortname)) {\n            $('#id_error_crb_reportshortname')\n                .html(M.util.get_string('nospecialchar', 'local_edwiserreports'))\n                .show();\n            ret = false;\n        }\n        return ret;\n    }\n\n    function customReportServiceInit() {\n        $(cfCheckbox).on('change', function () {\n            getCustomReportsData();\n        });\n        $(cfSelect).on('change', function () {\n            getCustomReportsData();\n        });\n        $(cfSave).on('click', function () {\n            modalFactory.create({\n                title: customReportSaveTitle,\n                type: modalFactory.types.SAVE_CANCEL,\n                body: templates.render('local_edwiserreports/custom_reports_save_form', {})\n            }).done(function(modal) {\n                var root = modal.getRoot();\n                modal.show();\n                root.on(modalEvents.save, function(e) {\n                    // Stop the default save button behaviour which is to close the modal.\n                    e.preventDefault();\n\n                    // Remove all error on type\n                    root.find('input').on('input', function() {\n                        $('[id^=\"id_error_crb\"]').html('');\n                    });\n\n                    var data = $(cfSaveForm).serializeArray().reduce(function(obj, item) {\n                        obj[item.name] = item.value;\n                        return obj;\n                    }, {});\n\n                    if (validateCustomReprtsSaveData(data)) {\n                        // Prepare query data\n                        data.querydata = {\n                            'selectedfield': selectedFields,\n                            'cohorts': cohorts,\n                            'courses': courses\n                        }\n\n                        var saveCustomReportsData = ajax.call([{\n                            methodname: 'local_edwiserreports_save_customreports_data',\n                            args: {\n                                params: JSON.stringify(data)\n                            }\n                        }]);\n\n                        saveCustomReportsData[0].done(function(response) {\n                            if (response.success) {\n                                notif.addNotification({\n                                    message: M.util.get_string('reportssavesuccess', 'local_edwiserreports'),\n                                    type: \"success\"\n                                });\n                            } else {\n                                notif.addNotification({\n                                    message: response.errormsg,\n                                    type: \"error\"\n                                });\n                            }\n                            $(\"html, body\").animate({ scrollTop: 0 }, \"slow\");\n                            modal.destroy();\n                        });\n                    }\n                });\n            });\n        });\n    }\n\n    return {\n        init : function () {\n            $(document).ready(function () {\n                customReportServiceInit();\n            });\n        }\n    }\n});\n"],"file":"customreportsblock.min.js"}